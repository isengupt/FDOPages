"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var simpl_schema_1 = tslib_1.__importDefault(require("simpl-schema"));
var cloneDeep_1 = tslib_1.__importDefault(require("lodash/cloneDeep"));
var invariant_1 = tslib_1.__importDefault(require("invariant"));
var uniforms_1 = require("uniforms");
var SimpleSchema2Bridge = /** @class */ (function (_super) {
    tslib_1.__extends(SimpleSchema2Bridge, _super);
    function SimpleSchema2Bridge(schema) {
        var _this = _super.call(this) || this;
        _this.schema = schema;
        return _this;
    }
    SimpleSchema2Bridge.check = function (schema) {
        return (schema &&
            schema.getDefinition &&
            schema.messageBox &&
            schema.objectKeys &&
            schema.validator &&
            schema.version === 2);
    };
    SimpleSchema2Bridge.prototype.getError = function (name, error) {
        return ((error &&
            error.details &&
            error.details.find &&
            error.details.find(function (error) { return error.name === name; })) ||
            null);
    };
    SimpleSchema2Bridge.prototype.getErrorMessage = function (name, error) {
        var scopedError = this.getError(name, error);
        return !scopedError ? '' : this.schema.messageForError(scopedError);
    };
    SimpleSchema2Bridge.prototype.getErrorMessages = function (error) {
        var _this = this;
        if (error) {
            if (Array.isArray(error.details)) {
                return error.details.map(function (error) { return _this.schema.messageForError(error); });
            }
            if (error.message) {
                return [error.message];
            }
        }
        if (error !== undefined) {
            return [error];
        }
        return [];
    };
    SimpleSchema2Bridge.prototype.getField = function (name) {
        var definition = this.schema.getDefinition(name);
        invariant_1.default(definition, 'Field not found in schema: "%s"', name);
        var merged = tslib_1.__assign(tslib_1.__assign({}, definition), definition.type[0]);
        // aldeed/node-simple-schema#27
        if (merged.autoValue &&
            (merged.autoValue.name === 'defaultAutoValueFunction' ||
                merged.autoValue.toString().indexOf('$setOnInsert:') !== -1) // FIXME: Hack.
        ) {
            try {
                merged.defaultValue = merged.autoValue.call({ operator: null });
            }
            catch (_) {
                /* ignore it */
            }
        }
        return merged;
    };
    SimpleSchema2Bridge.prototype.getInitialValue = function (name, props) {
        if (props === void 0) { props = {}; }
        var field = this.getField(name);
        if (field.type === Array) {
            var item_1 = this.getInitialValue(uniforms_1.joinName(name, '0'));
            var items = Math.max(props.initialCount || 0, field.minCount || 0);
            return Array.from({ length: items }, function () { return item_1; });
        }
        if (field.type === Object || SimpleSchema2Bridge.check(field.type)) {
            return {};
        }
        return field.defaultValue;
    };
    // eslint-disable-next-line complexity
    SimpleSchema2Bridge.prototype.getProps = function (name, props) {
        if (props === void 0) { props = {}; }
        // Type should be omitted.
        // eslint-disable-next-line no-unused-vars, prefer-const
        var _a = this.getField(name), optional = _a.optional, type = _a.type, uniforms = _a.uniforms, field = tslib_1.__rest(_a, ["optional", "type", "uniforms"]);
        field = tslib_1.__assign(tslib_1.__assign({}, field), { required: !optional });
        if (uniforms) {
            if (typeof uniforms === 'string' || typeof uniforms === 'function') {
                field = tslib_1.__assign(tslib_1.__assign({}, field), { component: uniforms });
            }
            else {
                field = tslib_1.__assign(tslib_1.__assign({}, field), uniforms);
            }
        }
        if (type === Array) {
            try {
                var itemProps = this.getProps(name + ".$", props);
                if (itemProps.allowedValues && !props.allowedValues) {
                    field.allowedValues = itemProps.allowedValues;
                }
                if (itemProps.transform && !props.transform) {
                    field.transform = itemProps.transform;
                }
            }
            catch (_) {
                /* ignore it */
            }
        }
        else if (type === Number) {
            field = tslib_1.__assign(tslib_1.__assign({}, field), { decimal: true });
        }
        var options = props.options || field.options;
        if (options) {
            if (typeof options === 'function') {
                options = options();
            }
            if (!Array.isArray(options)) {
                field = tslib_1.__assign(tslib_1.__assign({}, field), { transform: function (value) { return options[value]; }, allowedValues: Object.keys(options) });
            }
            else {
                field = tslib_1.__assign(tslib_1.__assign({}, field), { transform: function (value) {
                        return options.find(function (option) { return option.value === value; }).label;
                    }, allowedValues: options.map(function (option) { return option.value; }) });
            }
        }
        return field;
    };
    SimpleSchema2Bridge.prototype.getSubfields = function (name) {
        return this.schema.objectKeys(simpl_schema_1.default._makeGeneric(name));
    };
    SimpleSchema2Bridge.prototype.getType = function (name) {
        var type = this.getField(name).type;
        if (type === simpl_schema_1.default.Integer) {
            return Number;
        }
        if (SimpleSchema2Bridge.check(type)) {
            return Object;
        }
        return type;
    };
    SimpleSchema2Bridge.prototype.getValidator = function (options) {
        if (options === void 0) { options = { clean: true, mutate: true }; }
        var validator = this.schema.validator(options);
        // Clean mutate its argument, even if mutate is false.
        if (options.clean) {
            return function (model) { return validator(cloneDeep_1.default(tslib_1.__assign({}, model))); };
        }
        return validator;
    };
    return SimpleSchema2Bridge;
}(uniforms_1.Bridge));
exports.default = SimpleSchema2Bridge;
